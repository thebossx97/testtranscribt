<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Local browser-based audio transcription using Whisper AI. Upload files or capture screen/tab audio.">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://huggingface.co https://*.huggingface.co https://*.hf.co; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com https://r2cdn.perplexity.ai; connect-src 'self' https://huggingface.co https://*.huggingface.co https://*.hf.co https://cdn.jsdelivr.net blob: data:; worker-src 'self' blob: data:; child-src 'self' blob:; img-src 'self' data: blob:;">
    <title>Local Whisper Transcriber</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
<!-- Startup Loading Screen -->
<div id="startupScreen" class="startup-screen">
    <div class="startup-content">
        <div class="startup-logo">
            <h1>üéß Local Whisper Transcriber</h1>
            <p class="startup-subtitle">Loading AI Models...</p>
        </div>
        
        <div class="startup-progress-container">
            <div id="startupModelName" class="startup-model-name">Initializing...</div>
            
            <div class="startup-progress-bar">
                <div id="startupProgressFill" class="startup-progress-fill"></div>
            </div>
            
            <div id="startupProgressText" class="startup-progress-text">Preparing to download models...</div>
            
            <div id="startupModelList" class="startup-model-list">
                <div class="model-item" id="modelTiny">
                    <span class="model-icon">‚è≥</span>
                    <span class="model-label">Tiny Model (~75MB, multilingual)</span>
                    <span class="model-status">Waiting...</span>
                </div>
                <div class="model-item" id="modelBase">
                    <span class="model-icon">‚è≥</span>
                    <span class="model-label">Base Model (~145MB, multilingual)</span>
                    <span class="model-status">Waiting...</span>
                </div>
                <div class="model-item" id="modelSmall">
                    <span class="model-icon">‚è≥</span>
                    <span class="model-label">Small Model (~490MB, multilingual)</span>
                    <span class="model-status">Waiting...</span>
                </div>
            </div>
            
            <div class="startup-info">
                <p>First-time setup: Downloading ~365MB of AI models</p>
                <p>This takes 3-5 minutes but only happens once</p>
                <p>All models will be cached for instant future use</p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <header>
        <h1>üéß Local Whisper Transcriber</h1>
        <p class="subtitle">File upload + experimental screen/tab audio capture, all transcribed locally in your browser.</p>
    </header>

    <div class="layout">
        <div class="panel">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="transcript">üìù Transcript</button>
                <button class="tab-btn" data-tab="intelligence" id="intelligenceTab">üß† Intelligence</button>
                <button class="tab-btn" data-tab="history">üìã History</button>
            </div>

            <div id="alert" class="alert"></div>

            <!-- Transcript Tab -->
            <div class="tab-content active" data-tab="transcript">
            <h2 style="margin-top: 0;">Transcript</h2>

            <div class="control-group">
                <div class="model-selector">
                    <label for="modelSelect" style="font-size: 13px; color: var(--color-gray-400); margin-right: 6px;">
                        Model:
                    </label>
                    <select id="modelSelect">
                        <option value="Xenova/whisper-tiny">Tiny (~75MB, fastest)</option>
                        <option value="Xenova/whisper-base" selected>Base (~145MB, balanced)</option>
                        <option value="Xenova/whisper-small">Small (~490MB, most accurate)</option>
                    </select>
                </div>
                <div class="model-selector" style="margin-left: 12px;">
                    <label for="languageSelect" style="font-size: 13px; color: var(--color-gray-400); margin-right: 6px;">
                        Language:
                    </label>
                    <select id="languageSelect">
                        <option value="">Auto-detect</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="it">Italian</option>
                        <option value="pt">Portuguese</option>
                        <option value="nl">Dutch</option>
                        <option value="ru">Russian</option>
                        <option value="zh">Chinese</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="ar">Arabic</option>
                        <option value="hi">Hindi</option>
                        <option value="tr">Turkish</option>
                        <option value="pl">Polish</option>
                        <option value="uk">Ukrainian</option>
                        <option value="vi">Vietnamese</option>
                        <option value="th">Thai</option>
                        <option value="sv">Swedish</option>
                    </select>
                </div>
                <span class="badge">Runs 100% in browser</span>
            </div>

            <div id="status" class="status">
                <div class="status-dot"></div>
                <span id="statusText">Initializing...</span>
                <button id="loadModelBtn" class="btn btn-secondary" style="margin-left: auto; display: none;">Load Model</button>
            </div>
            
            <div id="progressBar" style="display:none; margin-bottom: 12px; background: rgba(0,0,0,0.1); border-radius: 4px; height: 12px; overflow: hidden; width: 100%;">
                <div id="progressFill" style="height: 100%; background: linear-gradient(90deg, var(--color-teal-500), var(--color-teal-600)); width: 0%; transition: width 0.3s ease;"></div>
            </div>

            <!-- Meeting Stats -->
            <div id="meetingStats" style="display: none; margin-bottom: 12px; padding: 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px;">
                <div style="display: flex; gap: 20px; font-size: 13px; color: var(--color-gray-300);">
                    <div>
                        <span style="color: var(--color-gray-500);">Duration:</span>
                        <strong id="statDuration" style="color: var(--color-blue-400); margin-left: 4px;">00:00</strong>
                    </div>
                    <div>
                        <span style="color: var(--color-gray-500);">Speakers:</span>
                        <strong id="statSpeakers" style="color: var(--color-green-400); margin-left: 4px;">0</strong>
                    </div>
                    <div>
                        <span style="color: var(--color-gray-500);">Utterances:</span>
                        <strong id="statUtterances" style="color: var(--color-orange-400); margin-left: 4px;">0</strong>
                    </div>
                    <div>
                        <span style="color: var(--color-gray-500);">Words:</span>
                        <strong id="statWords" style="color: var(--color-purple-400); margin-left: 4px;">0</strong>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <button id="copyBtn" class="btn btn-secondary" disabled>üìã Copy text</button>
                <button id="downloadBtn" class="btn btn-secondary" disabled>‚¨áÔ∏è Save as .txt</button>
                <button id="saveMeetingBtn" class="btn btn-secondary" disabled>üíæ Save Meeting</button>
                <button id="historyBtn" class="btn btn-secondary">üìã History</button>
            </div>

            <div id="progressText" class="hint"></div>

            <div id="transcript" class="transcript-area"></div>

            <div class="footer-note">
                First run will download all 3 multilingual models (~710MB total, cached in browser). This takes 5-10 minutes but only happens once. Subsequent visits load instantly. Supports 99 languages!
            </div>
            </div>
            <!-- End Transcript Tab -->

            <!-- Intelligence Tab -->
            <div class="tab-content" data-tab="intelligence">
                <h2 style="margin-top: 0;">üß† Meeting Intelligence</h2>
                
                <!-- AI Model Status -->
                <div id="aiModelStatus" class="ai-model-status">
                    <div class="status-indicator">
                        <span class="status-dot"></span>
                        <span id="aiStatusText">AI models not loaded</span>
                    </div>
                    <button id="loadAIModelsBtn" class="btn btn-primary btn-sm">Load AI Models</button>
                </div>

                <!-- AI Loading Progress -->
                <div id="aiLoadingProgress" style="display: none; margin-bottom: 16px;">
                    <div class="progress-bar-container">
                        <div id="aiProgressFill" class="progress-fill"></div>
                    </div>
                    <div id="aiProgressText" class="progress-text">Loading AI models...</div>
                </div>

                <!-- Intelligence Content (shown after processing) -->
                <div id="intelligenceContent" style="display: none;">
                    <!-- Summary Section -->
                    <div class="intelligence-section">
                        <h3>üìÑ Summary</h3>
                        <div id="summaryContent" class="summary-content">
                            <div class="summary-executive">
                                <strong>Executive Summary:</strong>
                                <p id="summaryExecutive">No summary available yet.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Items Section -->
                    <div class="intelligence-section">
                        <h3>‚úÖ Action Items</h3>
                        <div id="actionItemsList" class="action-items-list">
                            <p class="empty-state">No action items detected yet.</p>
                        </div>
                    </div>

                    <!-- Decisions Section -->
                    <div class="intelligence-section">
                        <h3>üéØ Key Decisions</h3>
                        <div id="decisionsList" class="decisions-list">
                            <p class="empty-state">No decisions detected yet.</p>
                        </div>
                    </div>

                    <!-- Topics Section -->
                    <div class="intelligence-section">
                        <h3>üí° Main Topics</h3>
                        <div id="topicsList" class="topics-list">
                            <p class="empty-state">No topics detected yet.</p>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="intelligenceEmptyState" class="empty-state-large">
                    <p>üéôÔ∏è Start a meeting or load a transcript to generate intelligence insights.</p>
                    <p class="hint">AI will automatically extract summaries, action items, decisions, and key topics.</p>
                </div>
            </div>
            <!-- End Intelligence Tab -->

            <!-- History Tab -->
            <div class="tab-content" data-tab="history">
                <h2 style="margin-top: 0;">üìã Meeting History</h2>
                <div id="meetingsHistoryContent">
                    <!-- Will be populated by refreshMeetingsHistory() -->
                </div>
            </div>
            <!-- End History Tab -->

        </div>

        <div class="panel">
            <h2>Inputs</h2>

            <h3 style="font-size: 14px; margin-top: 0;">1. Upload audio file</h3>
            <div class="control-group">
                <input type="file" id="fileInput" accept="audio/*,video/*" style="display:none;">
                <button id="selectFileBtn" class="btn btn-primary">üìÅ Choose audio file</button>
            </div>
            <div class="control-group">
                <span id="fileName" class="hint">No file selected</span>
            </div>
            <div class="control-group">
                <button id="transcribeFileBtn" class="btn btn-secondary" disabled>‚ñ∂Ô∏è Transcribe file</button>
            </div>

            <hr style="margin: var(--space-16) 0; border: none; border-top: 1px solid rgba(0,0,0,0.06);" />

            <h3 style="font-size: 14px;">2. Experimental: capture screen/tab audio</h3>
            <p class="small-note">
                Works best in Chrome/Edge on desktop when you share a tab with "Share audio" enabled.
                Behavior varies by OS and browser. Treat this as experimental.
            </p>
            <div class="control-group">
                <button id="startShareBtn" class="btn btn-primary">üñ•Ô∏è Share screen/tab + audio</button>
                <button id="stopShareBtn" class="btn btn-danger" disabled>‚èπ Stop capture</button>
            </div>
            <p class="small-note">
                When you click "Share", choose the tab/window/screen that plays the audio you want, and enable audio sharing if offered.
            </p>
        </div>
    </div>
</div>

<script type="module">
    // Import transformers.js - using latest stable version
    // Note: Whisper models may not be fully supported, using what's available
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';
    
    // Make available globally
    window.pipeline = pipeline;
    window.env = env;
    
    console.log('Transformers.js loaded');
    console.log('Pipeline:', typeof pipeline);
    console.log('Env:', typeof env);
    
    // Load app after transformers.js is ready
    const appScript = document.createElement('script');
    appScript.src = 'js/app.js';
    document.body.appendChild(appScript);
</script>

<!-- Meeting History Sidebar -->
<div id="meetingsSidebar" class="meetings-sidebar">
    <div class="sidebar-header">
        <h3 style="margin: 0; font-size: 1.1rem;">Meeting History</h3>
        <button id="closeSidebarBtn" class="btn-close">‚úï</button>
    </div>
    <div id="meetingsList" class="meetings-list">
        <div style="color: #666; font-size: 0.85rem; padding: 1rem;">Loading meetings...</div>
    </div>
</div>

</body>
</html>
